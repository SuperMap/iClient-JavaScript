<!--********************************************************************
* Copyright© 2000 - 2023 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>turf ugc buffer 对比示例</title>
    <script type="text/javascript" src="../js/include-web.js"></script>
    <script type="text/javascript" include="turf" src="../../dist/mapboxgl/include-mapboxgl.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #fff;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
      }

      .item {
        display: inline-block;
        margin-right: 50px;
      }

      .rect-blue {
        width: 20px;
        height: 20px;
        display: inline-block;
        background-color: blue;
      }

      .rect-red {
        width: 20px;
        display: inline-block;
        height: 20px;
        background-color: red;
      }

      span {
        margin-right: 20px;
      }
    </style>
  </head>

  <body>
    <div class="control-box">
      <div class="item">
        <h3>点数量设置:</h3>
        <input class="point-number" type="number" value="200" />
        <!-- <input
          class="point-number"
          type="range"
          value="200"
          step="1"
          min="1"
          max="1000"
        /> -->
      </div>
      <div class="item">
        <h3>缓冲区半径(米):</h3>
        <input class="radius" type="number" value="300" />
        <!-- <input class="turf-radius" type="range" value="300" min="1" max="1000" /> -->
      </div>
      <div class="item">
        <div><span class="rect-red"></span><span>UGC</span>计算时间为: <span class="ugc-time"></span></div>
        <div><span class="rect-blue"></span><span>Turf.js</span>计算时间为: <span class="turf-time"></span></div>
      </div>
    </div>
    <div id="map" style="width: 100%; height: 100%"></div>
    <!-- <link rel="stylesheet" href="./mapbox.css" />
  <script src="./mapbox.js"></script>
  <script src="./UGCWasmAll.js"></script> -->
    <script>
      // import ugGeometry2Geojson from '../src/UGGeometry2GeoJson.js'

      handleBar();
      var map;
      var markerList = [];
      var pointNum = 400;
      var radius = 30000;
      document.querySelector('.point-number').value = pointNum;
      document.querySelector('.radius').value = radius;
      var pointExtent = [120, 30, 125, 35];
      var url =
        'https://iserver.supermap.io/iserver/services/map-world/rest/maps/World/zxyTileImage.png?z={z}&x={x}&y={y}';
      function initMap(url) {
        return new Promise((resolve) => {
          map = new mapboxgl.Map({
            container: 'map',
            style: {
              version: 8,
              sources: {
                'raster-tiles': {
                  type: 'raster',
                  tiles: [url],
                  tileSize: 256
                }
              },
              layers: [
                {
                  id: 'simple-tiles',
                  type: 'raster',
                  source: 'raster-tiles'
                }
              ]
            },
            center: [pointExtent[0] + 2, pointExtent[1] + 2],
            zoom: 6
          });
          map.on('load', function () {
            resolve(map);
          });
        });
      }

      function handleBar() {
        document.querySelector('.control-box').addEventListener('change', function (e) {
          if (e.target.className === 'point-number') {
            pointNum = e.target.value;
          } else if (e.target.className === 'radius') {
            radius = e.target.value;
          }
          update();
          let nodeList = [...document.querySelectorAll(`.${e.target.className}`)];
          nodeList.forEach((node) => {
            node.value = +e.target.value;
          });
        });
      }

      function createPoints(pointNum, pointExtent) {
        const points = [];
        for (let i = 0; i < pointNum; i++) {
          let x = Math.random() * (pointExtent[2] - pointExtent[0]) + pointExtent[0];
          let y = Math.random() * (pointExtent[3] - pointExtent[1]) + pointExtent[1];
          points.push([x, y]);
        }
        return points;
      }

      function createTurfBuffer(radius) {
        let count1 = performance.now();
        let result = turf.distance(
          {
            type: 'Feature',
            properties: {},
            geometry: {
              coordinates: [93, 67],
              type: 'Point'
            }
          },
          {
            type: 'Feature',
            properties: {},
            geometry: {
              coordinates: [93, 70],
              type: 'Point'
            }
          },
          { units: 'degrees' }
        );
        let count2 = performance.now() - count1;
        document.querySelector('.turf-time').innerText = count2 + 'ms';
        console.log('turf:', count2, result);
        return result;
      }

      function createUGCBuffer(points, radius) {
        /*********************此处进行 ugc 逻辑替换！！！！！！！！！！！！！！！！********************/
        let count1 = performance.now();
        const result = mapboxgl.supermap.GeometryUtil.resample(
          {
            type: 'Feature',
            properties: {},
            geometry: {
              coordinates: [
                [
                  [42.68359374999926, 62.777396701237194],
                  [64.12890624999898, 64.79523044930204],
                  [63.953124999999545, 65.6786858190815],
                  [63.249999999999574, 66.8114240715017],
                  [62.37109374999898, 67.49389301612896],
                  [61.492187499999574, 68.28772132452241],
                  [60.261718749999005, 69.24256158321563],
                  [57.44921874999906, 69.73527228161362],
                  [54.28515624999915, 70.15718704882335],
                  [50.41796874999915, 70.51210723691744],
                  [47.07812499999977, 70.27617793103235],
                  [42.85937499999977, 69.42865648122586],
                  [42.85937499999977, 67.49389301612896],
                  [40.39843749999986, 65.53348822406599],
                  [38.28906249999986, 64.86998388328377],
                  [35.652343749999346, 63.72666005814014],
                  [34.42187499999994, 62.53517479812743],
                  [33.01562499999994, 61.294036659613994],
                  [32.66406249999994, 59.737073168028644],
                  [34.949218749999346, 58.74830965992459],
                  [37.58593749999986, 57.73060640379683],
                  [39.69531249999986, 56.3926803580984],
                  [44.26562499999977, 56.001509528428585],
                  [48.484374999999744, 55.90309268002264],
                  [51.29687499999969, 56.001509528428585],
                  [54.98828124999915, 56.779873589048776],
                  [59.207031249999005, 58.196819859924375],
                  [61.140624999999574, 59.470250136182244],
                  [63.249999999999574, 61.378353468156746],
                  [63.77734374999898, 61.96224580243168],
                  [61.843749999999574, 63.25592936693977],
                  [59.382812499999574, 63.41370175607415],
                  [42.68359374999926, 62.777396701237194]
                ]
              ],
              type: 'Polygon'
            }
          },
          0.5
        );
        let count2 = performance.now() - count1;
        document.querySelector('.ugc-time').innerText = count2 + 'ms';
        console.log('ugc:', count2, result);
        return result;
      }

      function clearMarker() {
        markerList.forEach((marker) => {
          marker.remove();
        });
      }
      function clearLayer(name) {
        if (!map) {
          return;
        }
        if (map.getLayer(name + 'outline')) {
          map.removeLayer(name + 'outline');
          map.removeSource(name);
        }
      }
      initMap(url).then((map) => {
        let points = createPoints(pointNum, pointExtent);
        update();
      });

      function addResultLayer(map, name, data, fillStyle, lineStyle) {
        if (map.getLayer(name + 'outline')) {
          map.removeLayer(name + 'outline');
          map.removeSource(name);
        }
        map.addSource(name, {
          type: 'geojson',
          data: data
        });
        map.addLayer({
          id: name + 'outline',
          type: 'fill',
          source: name,
          paint: lineStyle || {
            'fill-color': 'rgba(255,0,0,0.5)'
          }
        });
      }

      function update() {
        document.querySelector('.turf-time').innerText = '';
        document.querySelector('.ugc-time').innerText = '';
        clearMarker();
        clearLayer('turfBuffer');
        clearLayer('ugcBuffer');
        let points = createPoints(pointNum, pointExtent);

        let turfRes = createTurfBuffer(points, radius);
        let ugcRes = createUGCBuffer(points, radius);
        // addResultLayer(map, 'turfBuffer', turfRes, null, {
        //   'fill-color': 'rgba(0,0,255,0.5)'
        // });
        // addResultLayer(map, 'ugcBuffer', ugcRes, null, {
        //   'fill-color': 'rgba(255,0,0,0.5)'
        // });
      }
    </script>
  </body>
</html>
