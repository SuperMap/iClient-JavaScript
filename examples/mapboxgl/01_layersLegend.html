<!--********************************************************************
* Copyright© 2000 - 2023 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title data-i18n="resources.title_layerService"></title>
</head>
<body style=" margin: 0;overflow: hidden;background: #fff;width: 100%;height:100%;position: absolute;top: 0;">
<div id="map" style="width: 100%;height:100%">
  <div style="z-index: 100;position: relative;width: 250px;float:right">
    <div class="panel panel-primary" style="width:250px;margin-top: 20px;position: absolute;float:right">
      <div class="panel-heading">
        <h5 class='panel-title text-center'>
            <span data-i18n="resources.text_layerList"></span>
        </h5>
      </div>
      <div class="panel-body" id="layersList"></div>

    </div>
    <div class="panel panel-primary legend" style="width:250px;margin-top: 400px;position: absolute;float:right;max-height: 500px;overflow: auto;">
      <div class="panel-heading">
          <h5 class='panel-title text-center'>
              <span data-i18n="resources.text_legend"></span>
          </h5>
      </div>
      <div class="panel-body" id="mapLegend"></div>
    </div>
  </div>
</div>

<script type="text/javascript" include="bootstrap-css" src="../js/include-web.js"></script>
<script type="text/javascript" src="../../dist/mapboxgl/include-mapboxgl.js"></script>
<script type="text/javascript">
    var url = (window.isLocal ? window.server : "https://iserver.supermap.io") + "/iserver/services/map-jingjin/rest/maps/京津地区土地利用现状图";
    baseUrl = (window.isLocal ? window.server : "https://iserver.supermap.io") + "/iserver/services/map-jingjin/rest/maps/京津地区土地利用现状图/zxyTileImage.png?z={z}&x={x}&y={y}",
    attribution = "<a href='https://www.mapbox.com/about/maps/' target='_blank'>© Mapbox </a>" +
            " with <span>© <a href='https://iclient.supermap.io' target='_blank'>SuperMap iClient</a> | </span>" +
            " Map Data <span>© <a href='http://support.supermap.com.cn/product/iServer.aspx' target='_blank'>SuperMap iServer</a></span> ";
    map = new mapboxgl.Map({
        container: 'map',
        style: {
            "version": 8,
            "sources": {
                "raster-tiles": {
                    "attribution": attribution,
                    "type": "raster",
                    "tiles": [baseUrl],
                    "tileSize": 256
                }
            },
            "layers": [{
                "id": "simple-tiles",
                "type": "raster",
                "source": "raster-tiles",
            }]
        },
        center: [117.08 , 40.04],
        zoom: 7
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-left');
    map.addControl(new mapboxgl.supermap.LogoControl({ link: "https://iclient.supermap.io" }), 'bottom-right');
    getLayers();

    function getLayers() {
        new mapboxgl.supermap.LayerInfoService(url).getLayersInfo(function (serviceResult) {
            console.log(serviceResult)
            serviceResult.result.subLayers.layers.map(function (layer) {
              var checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.value = layer.name;
              var label = document.createElement('label');
              label.textContent = layer.name;
              label.style.marginLeft = "15px"
              layersList.appendChild(checkbox);
              layersList.appendChild(label);
              // 初始化，默认获取土地利用图层图例
              if(checkbox.value === "Landuse_R@Jingjin#1"){
                checkbox.checked = true;
                createLegend();
              }
              var brElement = document.createElement('br');
              layersList.appendChild(brElement);
            });
            var submitBtn = document.createElement('input');
            submitBtn.type = 'button';
            submitBtn.classList ='btn btn-default';
            submitBtn.value = resources.btn_getLegend;
            submitBtn.addEventListener('click', createLegend);
            layersList.appendChild(submitBtn);
        });
    }

    function createLegend() {
        var legendContainer = document.getElementById("mapLegend");
        legendContainer.innerHTML = ''
        // 获取所有被选中的图层，并拼接成参数
        var checkboxes = document.querySelectorAll('#layersList input[type="checkbox"]')
        var layers = "";
        checkboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            layers += checkbox.value + "@@京津地区土地利用现状图,"
          }
        });

        // 发起请求，获取图例
        var getLayersLegendInfoParams = new mapboxgl.supermap.GetLayersLegendInfoParameters({
          // bbox 或 layers 参数必须至少设置一个参数
          // bbox: "114.59,37.76,119.51,42.31",
          layers: "show:" + layers,
          width: 18,
          height: 18
        })
        new mapboxgl.supermap.LayerInfoService(url).getLayersLegendInfo(getLayersLegendInfoParams,function (serviceResult) {
            serviceResult.result.layerLegends.map(function (layerLegend) { 
              layerLegend.legends.map(function (legend) { 
                var legendPic = document.createElement('img');
                var legendLabel = document.createElement('span');
                legendLabel.innerHTML = legend.label;
                legendLabel.style.marginLeft = "15px"
                // legendPic.src = legend.url;
                legendPic.src = 'data:image/png;base64,' + legend.imageData;
                legendContainer.appendChild(legendPic);
                legendContainer.appendChild(legendLabel);
                var brElement = document.createElement('br');
                legendContainer.appendChild(brElement);
               })
            })
        });
    }
</script>
</body>
</html>