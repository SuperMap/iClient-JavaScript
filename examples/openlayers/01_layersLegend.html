<!--********************************************************************
* Copyright© 2000 - 2023 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title data-i18n="resources.title_layerService"></title>
</head>
<body style=" margin: 0;overflow: hidden;background: #fff;width: 100%;height:100%;position: absolute;top: 0;">
<div id="map" style="width: 100%;height:100%">
  <div style="z-index: 100;position: relative;width: 250px;float:right">
    <div class="panel panel-primary" style="width:250px;margin-top: 20px;position: absolute;float:right">
      <div class="panel-heading">
        <h5 class='panel-title text-center'>
            <span data-i18n="resources.text_layerList"></span>
        </h5>
      </div>
      <div class="panel-body" id="layersList"></div>

    </div>
    <div class="panel panel-primary legend" style="width:250px;margin-top: 400px;position: absolute;float:right;max-height: 500px;overflow: auto;">
      <div class="panel-heading">
          <h5 class='panel-title text-center'>
              <span data-i18n="resources.text_legend"></span>
          </h5>
      </div>
      <div class="panel-body" id="mapLegend"></div>
    </div>
  </div>
</div>

<script type="text/javascript" include="bootstrap-css" src="../js/include-web.js"></script>
<script type="text/javascript" src="../../dist/ol/include-ol.js"></script>
<script type="text/javascript">
    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var overlay = new ol.Overlay(({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    }));
    var url = (window.isLocal ? window.server : "https://iserver.supermap.io")+"/iserver/services/map-jingjin/rest/maps/京津地区土地利用现状图";
    map = new ol.Map({
        target: 'map',
        controls: ol.control.defaults({attributionOptions: {collapsed: false}})
            .extend([new ol.supermap.control.Logo()]),
        view: new ol.View({
            center: [117.08 , 40.04],
            zoom: 8,
            projection: 'EPSG:4326',
            multiWorld: true
        }),
        overlays: [overlay]
    });
    var layer = new ol.layer.Tile({
        source: new ol.source.TileSuperMapRest({
            url: url
        }),
        projection: 'EPSG:4326'
    });
    map.addLayer(layer);
    getLayers();

    function getLayers() {
        new ol.supermap.LayerInfoService(url).getLayersInfo().then(function (serviceResult) {
            serviceResult.result.subLayers.layers.map(function (layer) {
              var checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.value = layer.name;
              var label = document.createElement('label');
              label.textContent = layer.name;
              label.style.marginLeft = "15px"
              layersList.appendChild(checkbox);
              layersList.appendChild(label);
              // 初始化，默认获取土地利用图层图例
              if(checkbox.value === "Landuse_R@Jingjin#1"){
                checkbox.checked = true;
                createLegend();
              }
              var brElement = document.createElement('br');
              layersList.appendChild(brElement);
            });
            var submitBtn = document.createElement('input');
            submitBtn.type = 'button';
            submitBtn.classList ='btn btn-default';
            submitBtn.value = resources.btn_getLegend;
            submitBtn.addEventListener('click', createLegend);
            layersList.appendChild(submitBtn);
        });
    }

    function createLegend() {
        var legendContainer = document.getElementById("mapLegend");
        legendContainer.innerHTML = ''
        // 获取所有被选中的图层，并拼接成参数
        var checkboxes = document.querySelectorAll('#layersList input[type="checkbox"]')
        var layers = "";
        checkboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            layers += checkbox.value + "@@京津地区土地利用现状图,"
          }
        });

        // 发起请求，获取图例
        var getLayersLegendInfoParams = new ol.supermap.GetLayersLegendInfoParameters({
          // bbox 或 layers 参数必须至少设置一个参数
          // bbox: "114.59,37.76,119.51,42.31",
          layers: "show:" + layers,
          width: 18,
          height: 18
        })
        new ol.supermap.LayerInfoService(url).getLayersLegendInfo(getLayersLegendInfoParams).then(function (serviceResult) {
          serviceResult.result.layerLegends.map(function (layerLegend) { 
              layerLegend.legends.map(function (legend) { 
                var legendPic = document.createElement('img');
                var legendLabel = document.createElement('span');
                legendLabel.innerHTML = legend.label;
                legendLabel.style.marginLeft = "15px"
                // legendPic.src = legend.url;
                legendPic.src = 'data:image/png;base64,' + legend.imageData;
                legendContainer.appendChild(legendPic);
                legendContainer.appendChild(legendLabel);
                var brElement = document.createElement('br');
                legendContainer.appendChild(brElement);
               })
            })
        });
    }
</script>
</body>
</html>