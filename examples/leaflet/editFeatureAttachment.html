<!--********************************************************************
* Copyright© 2000 - 2023 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title data-i18n="resources.title_editFeatureAttachments"></title>
    <script type="text/javascript" src="../../dist/leaflet/include-leaflet.js"></script>
    <style>
        .editPane {
            position: absolute;
            right: 65px;
            top: 8px;
            text-align: center;
            background: #FFF;
            z-index: 1000;
            border-radius: 4px;
        }

        #atfile {
            width: 225px;
        }

        .tooltip {
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            color: white;
            padding: 4px 8px;
            opacity: 0.7;
            white-space: nowrap;
        }

        .leaflet-popup-scrollable {
            overflow: auto;
        }
    </style>
</head>

<body style=" margin: 0;overflow: hidden;background: #fff;width: 100%;height:100%; position: absolute;top: 0;">
    <div id="map" style="width: 100%;height:100%"></div>
    <div class="panel panel-primary editPane" id="editPane">
        <div class='panel-heading'>
            <h5 class='panel-title text-center' data-i18n="resources.text_editSingle"></h5>
        </div>
        <div class='panel-body content file' style="padding-bottom: 0;">
            <input type='file' id="atfile" class='btn btn-default' data-i18n="[value]resources.btn_addMarker" />&nbsp;
        </div>
        <div class='panel-body content'>
            <input type='button' class='btn btn-default' data-i18n="[value]resources.text_getAttachments"
                onclick='getAttachments()' />
            <input type='button' class='btn btn-default' data-i18n="[value]resources.btn_undoAdd"
                onclick='revocationMarker()' />
            <input type='button' class='btn btn-default' data-i18n="[value]resources.text_input_value_submit"
                onclick='commit()' />&nbsp;
        </div>
    </div>
    <script type="text/javascript" include="bootstrap,widgets.alert" src="../js/include-web.js"></script>
    <script type="text/javascript">
        var map, id, pointFeature, vectorSource, resultLayer, editFeaturesService, alertDiv,
            addPointsSource, addPointsLayer,
            host = window.isLocal ? window.server : "https://iserver.supermap.io",
            baseUrl = host + "/iserver/services/map-world/rest/maps/World",
            url = host + "/iserver/services/data-world/rest/data",
            // url = "http://localhost:8090" + "/iserver/services/data-world/rest/data",
            dom = document.getElementById('atfile'),
            file,
            lastTarget;
        map = L.map('map', {
            preferCanvas: true,
            crs: L.CRS.EPSG4326,
            center: { lon: 0, lat: 0 },
            maxZoom: 18,
            zoom: 2
        });
        new L.supermap.TiledMapLayer(baseUrl).addTo(map);

        initFeature()
        // loadLayer()
        function loadLayer() {
            //添加查询结果图层
            vectorSource = new ol.source.Vector({
                wrapX: false
            });
            resultLayer = new ol.layer.Vector({
                source: vectorSource,
            });
            map.addLayer(resultLayer);
        }

        function initFeature() {
            var sqlParam = new L.supermap.GetFeaturesBySQLParameters({
                queryParameter: {
                    name: "Countries@World",
                    attributeFilter: "SMID > 0"
                },
                datasetNames: ["World:Countries"]
            });
            new L.supermap.FeatureService(url).getFeaturesBySQL(sqlParam, function (serviceResult) {
                resultLayer = L.geoJSON(serviceResult.result.features, {
                    onEachFeature: function (feature, layer) {
                        layer.on({
                            click: (e) => {
                                if (lastTarget) {
                                    resultLayer.resetStyle(lastTarget);
                                }
                                if (e.target) {
                                    lastTarget = e.target
                                }

                                // console.log(feature.properties.SMID);
                                id = feature.properties.SMID - 1
                                let layer = e.target;
                                layer.setStyle({
                                    weight: 3,
                                    color: 'red',
                                    dashArray: '',
                                    // fillOpacity: 0.7
                                })
                            }
                        })

                    }
                }).addTo(map)
                // map.eachLayer(function (layer) {
                //     console.log(layer);
                // })
            });
        }
        function getAttachments() {
            if (id) {
                var Params = new L.supermap.EditFeatureAttachmentsParameters({
                    dataSourceName: "World",
                    dataSetName: "Countries",
                    id: id,
                });
                var re = new L.supermap.FeatureAttachmentsService(url)
                re.attachmentsSupport(Params, function (serviceResult) {
                    if (!serviceResult.result.supportAttachments) {
                        return widgets.alert.showAlert(resources.title_notSupportAttachments, false);
                    }
                    re.featureAttachments(Params, function (serviceResult) {
                        result = serviceResult.result
                        let innerHTML = ''
                        if (result) {
                            result.forEach(function (i) {
                                innerHTML += "attachmentName:" + i.name + "<br>"
                                innerHTML += "attachmentType:" + i.contentType + "<br>"
                                innerHTML += "attachmentSize:" + i.size
                                innerHTML += "<hr>"
                            })
                        }
                        infoWin = L.popup({
                            minWidth: 180,
                            maxWidth: 800,
                            maxHeight: 200,
                        })
                            .setLatLng(map.getCenter())
                            .setContent(innerHTML || resources.text_noData)
                            .openOn(map);
                    })

                })
            } else {
                widgets.alert.showAlert(resources.msg_noFeature, false);
            }

        }


        function revocationMarker() {
            dom.value = ''
            file = null
        }

        function commit() {
            file = dom.files[0]
            if (file && id) {
                const form = new FormData();
                form.append('file', file)
                var Params = new L.supermap.EditFeatureAttachmentsParameters({
                    dataSourceName: "World",
                    dataSetName: "Countries",
                    id: id,
                    file: form,
                });
                var re = new L.supermap.FeatureAttachmentsService(url).featureAttachments(Params, function (serviceResult) {
                    widgets.alert.showAlert(resources.msg_submitSuccess, true);
                })
            } else {
                let msg = file ? resources.msg_noFeature : resources.msg_noFileToSubmit
                widgets.alert.showAlert(msg, false);
            }

        }

    </script>
</body>

</html>