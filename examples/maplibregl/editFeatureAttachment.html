<!--********************************************************************
* Copyright© 2000 - 2023 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title data-i18n="resources.title_editFeatureAttachments"></title>
    <script type="text/javascript" src="../../dist/maplibregl/include-maplibregl.js"></script>
    <style>
        .editPane {
            position: absolute;
            right: 65px;
            top: 8px;
            text-align: center;
            background: #FFF;
            z-index: 1000;
            border-radius: 4px;
        }

        #atfile {
            width: 225px;
        }

        .tooltip {
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            color: white;
            padding: 4px 8px;
            opacity: 0.7;
            white-space: nowrap;
        }

        .my-popup-class {
            width: 200px;
            height: 200px;
            overflow: auto;
        }
    </style>
</head>

<body style=" margin: 0;overflow: hidden;background: #fff;width: 100%;height:100%; position: absolute;top: 0;">
    <div id="map" style="width: 100%;height:100%"></div>
    <div class="panel panel-primary editPane" id="editPane">
        <div class='panel-heading'>
            <h5 class='panel-title text-center' data-i18n="resources.text_editSingle"></h5>
        </div>
        <div class='panel-body content file' style="padding-bottom: 0;">
            <input type='file' id="atfile" class='btn btn-default' data-i18n="[value]resources.btn_addMarker" />&nbsp;
        </div>
        <div class='panel-body content'>
            <input type='button' class='btn btn-default' data-i18n="[value]resources.text_getAttachments"
                onclick='getAttachments()' />
            <input type='button' class='btn btn-default' data-i18n="[value]resources.btn_undoAdd"
                onclick='revocationMarker()' />
            <input type='button' class='btn btn-default' data-i18n="[value]resources.text_input_value_submit"
                onclick='commit()' />&nbsp;
        </div>
    </div>
    <script type="text/javascript" include="bootstrap,widgets.alert" src="../js/include-web.js"></script>
    <script type="text/javascript">
        var attribution = "<a href='https://www.mapbox.com/about/maps/' target='_blank'>© Mapbox </a>" +
            "with <span>© <a href='https://iclient.supermap.io' target='_blank'>SuperMap iClient</a> | </span>" +
            " Map Data <span>© <a href='http://support.supermap.com.cn/product/iServer.aspx' target='_blank'>SuperMap iServer</a></span>";
        var map, id, pointFeature, vectorSource, resultLayer, editFeaturesService, alertDiv,
            addPointsSource, addPointsLayer,
            host = window.isLocal ? window.server : "https://iserver.supermap.io",
            baseUrl = host + "/iserver/services/map-world/rest/maps/World/zxyTileImage.png?z={z}&x={x}&y={y}",
            url = host + "/iserver/services/data-world/rest/data",
            // url = "http://localhost:8090" + "/iserver/services/data-world/rest/data",
            dom = document.getElementById('atfile'),
            file,
            lastTarget;

        map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "sources": {
                    "raster-tiles": {
                        "attribution": attribution,
                        "type": "raster",
                        "tiles": [baseUrl],
                        "tileSize": 256
                    }
                },
                "layers": [{
                    "id": "simple-tiles",
                    "type": "raster",
                    "source": "raster-tiles",
                }]
            },
            center: [-10, 15],
            zoom: 2
        });
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.addControl(new maplibregl.supermap.LogoControl({ link: "https://iclient.supermap.io" }), 'bottom-right');


        initFeature()
        // loadLayer()
        function loadLayer() {
            //添加查询结果图层
            vectorSource = new ol.source.Vector({
                wrapX: false
            });
            resultLayer = new ol.layer.Vector({
                source: vectorSource,
            });
            map.addLayer(resultLayer);
        }

        function initFeature() {
            var sqlParam = new maplibregl.supermap.GetFeaturesBySQLParameters({
                queryParameter: {
                    name: "Countries@World",
                    attributeFilter: "SMID > 0"
                },
                datasetNames: ["World:Countries"]
            });
            new maplibregl.supermap.FeatureService(url).getFeaturesBySQL(sqlParam, function (serviceResult) {
                let features = serviceResult.result.features.features
                for (let i = 0; i < features.length; i++) {
                    map.addSource("dataSource" + i, {
                        type: "geojson",
                        data: features[i]
                    })
                    map.addLayer({
                        id: "layer" + i,
                        source: "dataSource" + i,
                        type: "fill",
                        paint: {
                            "fill-color": "#4692F3", /* 填充的颜色 */
                            "fill-opacity": 0.5
                        }
                    })
                    map.addLayer({
                        id: 'outline' + i,
                        type: 'line',
                        source: 'dataSource' + i,
                        layout: {},
                        paint: {
                            'line-color': '#4692F3',
                            'line-width': 3,
                        }
                    });
                    map.on('click', 'layer' + i, function (e) {
                        lineID = e.features[0].layer.id.substring(5)
                        outlineName = 'outline' + lineID
                        if (lastTarget) {
                            map.setPaintProperty(lastTarget, 'line-color', '#4692F3');
                        }

                        lastTarget = outlineName

                        map.setPaintProperty(outlineName, 'line-color', 'red');
                        id = e.features[0].properties.SMID - 1
                    })
                }
            });
        }

        function getAttachments() {
            if (id) {
                var Params = new maplibregl.supermap.EditFeatureAttachmentsParameters({
                    dataSourceName: "World",
                    dataSetName: "Countries",
                    id: id,
                });
                var re = new maplibregl.supermap.FeatureAttachmentsService(url)
                re.attachmentsSupport(Params, function (serviceResult) {
                    if (!serviceResult.result.supportAttachments) {
                        return widgets.alert.showAlert(resources.title_notSupportAttachments, false);
                    }
                    re.featureAttachments(Params, function (serviceResult) {
                        result = serviceResult.result
                        let innerHTML = ''
                        if (result) {
                            result.forEach(function (i) {
                                innerHTML += "attachmentName:" + i.name + "<br>"
                                innerHTML += "attachmentType:" + i.contentType + "<br>"
                                innerHTML += "attachmentSize:" + i.size
                                innerHTML += "<hr>"
                            })
                        }
                        new maplibregl.Popup({ className: 'my-popup-class' })
                            .setLngLat(map.getCenter())
                            .setHTML(innerHTML || resources.text_noData + "</br>")
                            .addTo(map);
                    })

                })
            } else {
                widgets.alert.showAlert(resources.msg_noFeature, false);
            }

        }


        function revocationMarker() {
            dom.value = ''
            file = null
        }

        function commit() {
            file = dom.files[0]
            if (file && id) {
                const form = new FormData();
                form.append('file', file)
                var Params = new mapboxgl.supermap.EditFeatureAttachmentsParameters({
                    dataSourceName: "World",
                    dataSetName: "Countries",
                    id: id,
                    file: form,
                });
                var re = new mapboxgl.supermap.FeatureAttachmentsService(url).featureAttachments(Params, function (serviceResult) {
                    widgets.alert.showAlert(resources.msg_submitSuccess, true);
                })
            } else {
                let msg = file ? resources.msg_noFeature : resources.msg_noFileToSubmit
                widgets.alert.showAlert(msg, false);
            }

        }

    </script>
</body>

</html>